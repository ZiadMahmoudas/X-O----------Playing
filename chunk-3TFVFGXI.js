import{a as U}from"./chunk-DLUWD6DK.js";import{d as z}from"./chunk-2EPKHZCL.js";import"./chunk-2X2WE554.js";import{a as F,c as E,h as N,p as L}from"./chunk-2GGCCMO2.js";import{a as k}from"./chunk-G5KA7DMQ.js";import{c as D}from"./chunk-D3ZEN3NJ.js";import{$ as f,Aa as O,Ea as _,Jb as y,Pb as S,Qb as A,Sb as T,Ta as l,Ua as s,Va as a,Wa as d,aa as M,ab as P,cb as p,eb as u,nb as h,pa as v,pb as c,qb as x,ra as r,rb as m,sb as b,tb as I,ub as w,va as C}from"./chunk-22QBDJS3.js";function B(o,n){if(o&1&&(s(0,"div",12),d(1,"i",13),c(2),a()),o&2){let e=u();r(2),m(" ",e.totalUnreadCount," \u063A\u064A\u0631 \u0645\u0642\u0631\u0648\u0621\u0629 ")}}function R(o,n){o&1&&(s(0,"div",14),d(1,"i",15),s(2,"p"),c(3,"\u062C\u0627\u0631\u064A \u062A\u062D\u0645\u064A\u0644 \u0627\u0644\u0645\u062D\u0627\u062F\u062B\u0627\u062A..."),a()())}function V(o,n){o&1&&(s(0,"div",16),d(1,"i",17),s(2,"h3"),c(3,"\u0644\u0627 \u062A\u0648\u062C\u062F \u0645\u062D\u0627\u062F\u062B\u0627\u062A"),a(),s(4,"p"),c(5,"\u0627\u0628\u062F\u0623 \u0645\u062D\u0627\u062F\u062B\u0629 \u062C\u062F\u064A\u062F\u0629 \u0645\u0639 \u0623\u062D\u062F \u0627\u0644\u0623\u0639\u0636\u0627\u0621"),a()())}function W(o,n){if(o&1&&(s(0,"div",16),d(1,"i",18),s(2,"h3"),c(3,"\u0644\u0627 \u062A\u0648\u062C\u062F \u0646\u062A\u0627\u0626\u062C"),a(),s(4,"p"),c(5),a()()),o&2){let e=u();r(5),m('\u0644\u0645 \u064A\u062A\u0645 \u0627\u0644\u0639\u062B\u0648\u0631 \u0639\u0644\u0649 \u0645\u062D\u0627\u062F\u062B\u0627\u062A \u062A\u0637\u0627\u0628\u0642 "',e.searchTerm,'"')}}function $(o,n){if(o&1&&(s(0,"span",30),c(1),a()),o&2){let e=u().$implicit;r(),m(" ",e.unreadCount," ")}}function q(o,n){if(o&1){let e=P();s(0,"div",21),p("click",function(){let i=f(e).$implicit,g=u(2);return M(g.openConversation(i))}),s(1,"div",22)(2,"img",23),p("error",function(i){return f(e),M(i.target.src="https://res.cloudinary.com/dsqtrbbmw/image/upload/v1760612462/user_ei8llz.jpg")}),a()(),s(3,"div",24)(4,"div",25)(5,"h3",26),c(6),a()(),s(7,"div",27)(8,"p",28),c(9),a(),_(10,$,2,1,"span",29),a()()()}if(o&2){let e=n.$implicit;r(2),l("src",e.userImage,v)("alt",e.userName),r(4),x(e.userName),r(2),h("unread",e.unreadCount>0),r(),m(" ",e.lastMessage," "),r(),l("ngIf",e.unreadCount>0)}}function Y(o,n){if(o&1&&(s(0,"div",19),_(1,q,11,7,"div",20),a()),o&2){let e=u();r(),l("ngForOf",e.filteredConversations)}}var j=class o{constructor(n,e,t,i){this.chatService=n;this.router=e;this.auth=t;this.cdr=i}conversations=[];filteredConversations=[];searchTerm="";currentUserId=0;isLoading=!0;subscriptions=[];ngOnInit(){console.log("\u{1F680} AllMessages initialized"),this.currentUserId=this.getCurrentUserId(),this.currentUserId>0?(this.loadConversations(),this.setupSignalR(),this.listenForNewMessages()):(this.isLoading=!1,this.cdr.detectChanges())}ngOnDestroy(){this.subscriptions.forEach(n=>n.unsubscribe())}getCurrentUserId(){let n=this.auth.getAccessToken();if(!n)return 0;try{let e=k(n),t=e.sub||e.userId;return parseInt(t)||0}catch{return 0}}async setupSignalR(){try{await this.chatService.startConnection(this.currentUserId),console.log("\u2705 SignalR connected")}catch(n){console.error("\u274C SignalR failed:",n)}}loadConversations(){this.isLoading=!0,this.cdr.detectChanges();let n=this.chatService.getAllConversations(this.currentUserId).subscribe({next:e=>{let t=e?.data||e||[];Array.isArray(t)?this.conversations=t.map(i=>({id:i.id,userId:i.userId,userName:i.userName||"\u0645\u0633\u062A\u062E\u062F\u0645",userImage:i.userImage||"https://res.cloudinary.com/dsqtrbbmw/image/upload/v1760612462/user_ei8llz.jpg",lastMessage:i.lastMessage||"\u0644\u0627 \u062A\u0648\u062C\u062F \u0631\u0633\u0627\u0626\u0644",lastMessageTime:i.lastMessageTime,unreadCount:i.unreadCount||0,isOnline:i.isOnline||!1})):this.conversations=[],this.filteredConversations=[...this.conversations],this.isLoading=!1,this.cdr.detectChanges(),console.log(`\u2705 Loaded ${this.conversations.length} conversations`)},error:e=>{console.error("\u274C Error loading conversations:",e),this.conversations=[],this.filteredConversations=[],this.isLoading=!1,this.cdr.detectChanges()}});this.subscriptions.push(n)}listenForNewMessages(){let n=this.chatService.message$.subscribe(e=>{e&&this.updateConversationWithNewMessage(e.senderId,e.content)});this.subscriptions.push(n)}updateConversationWithNewMessage(n,e){let t=this.conversations.find(i=>i.userId===n);t&&(t.lastMessage=e,t.lastMessageTime=new Date().toISOString(),this.router.url.includes(`${n}`)||t.unreadCount++,this.conversations=[t,...this.conversations.filter(g=>g.userId!==n)],this.filteredConversations=[...this.conversations],this.cdr.detectChanges())}onSearchChange(){if(!this.searchTerm.trim())this.filteredConversations=[...this.conversations];else{let n=this.searchTerm.toLowerCase();this.filteredConversations=this.conversations.filter(e=>e.userName.toLowerCase().includes(n)||e.lastMessage.toLowerCase().includes(n))}this.cdr.detectChanges()}async openConversation(n){if(console.log("\u{1F4C2} Opening chat with:",n.userName,"ID:",n.userId),!n.userId||n.userId<=0){console.error("\u274C Invalid userId");return}n.unreadCount=0,this.cdr.detectChanges();try{await this.router.navigate(["/chat",n.userId]),console.log("\u2705 Navigated to /chat/"+n.userId)}catch(e){console.error("\u274C Navigation error:",e)}}get totalUnreadCount(){return this.conversations.reduce((n,e)=>n+e.unreadCount,0)}trackByConversation(n,e){return e.userId}static \u0275fac=function(e){return new(e||o)(C(U),C(z),C(D),C(y))};static \u0275cmp=O({type:o,selectors:[["app-allmessages"]],decls:17,vars:7,consts:[[1,"allmessages-container"],[1,"messages-header"],[1,"header-title"],[1,"fas","fa-comments"],[1,"conversations-count"],["class","unread-badge",4,"ngIf"],[1,"search-container"],[1,"fas","fa-search","search-icon"],["type","text","placeholder","\u0627\u0628\u062D\u062B \u0639\u0646 \u0645\u062D\u0627\u062F\u062B\u0629...",1,"search-input",3,"ngModelChange","input","ngModel"],["class","loading-state",4,"ngIf"],["class","empty-state",4,"ngIf"],["class","conversations-list",4,"ngIf"],[1,"unread-badge"],[1,"fas","fa-bell"],[1,"loading-state"],[1,"fas","fa-spinner","fa-spin"],[1,"empty-state"],[1,"fas","fa-comments","fa-3x"],[1,"fas","fa-search","fa-3x"],[1,"conversations-list"],["class","conversation-item",3,"click",4,"ngFor","ngForOf"],[1,"conversation-item",3,"click"],[1,"avatar-container"],[1,"user-avatar",3,"error","src","alt"],[1,"conversation-info"],[1,"conversation-header"],[1,"user-name"],[1,"conversation-footer"],[1,"last-message"],["class","unread-count",4,"ngIf"],[1,"unread-count"]],template:function(e,t){e&1&&(s(0,"div",0)(1,"div",1)(2,"div",2),d(3,"i",3),s(4,"div")(5,"h1"),c(6,"\u0627\u0644\u0631\u0633\u0627\u0626\u0644"),a(),s(7,"p",4),c(8),a()()(),_(9,B,3,1,"div",5),a(),s(10,"div",6),d(11,"i",7),s(12,"input",8),w("ngModelChange",function(g){return I(t.searchTerm,g)||(t.searchTerm=g),g}),p("input",function(){return t.onSearchChange()}),a()(),_(13,R,4,0,"div",9)(14,V,6,0,"div",10)(15,W,6,1,"div",10)(16,Y,2,1,"div",11),a()),e&2&&(r(8),m("",t.conversations.length," \u0645\u062D\u0627\u062F\u062B\u0629"),r(),l("ngIf",t.totalUnreadCount>0),r(3),b("ngModel",t.searchTerm),r(),l("ngIf",t.isLoading),r(),l("ngIf",!t.isLoading&&t.filteredConversations.length===0&&!t.searchTerm),r(),l("ngIf",!t.isLoading&&t.filteredConversations.length===0&&t.searchTerm),r(),l("ngIf",!t.isLoading&&t.filteredConversations.length>0))},dependencies:[T,S,A,L,F,E,N],styles:[".allmessages-container[_ngcontent-%COMP%]{max-width:1200px;margin:0 auto;padding:24px;font-family:Cairo,Segoe UI,sans-serif;direction:rtl}.allmessages-container[_ngcontent-%COMP%]   .messages-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px}.allmessages-container[_ngcontent-%COMP%]   .messages-header[_ngcontent-%COMP%]   .header-title[_ngcontent-%COMP%]{display:flex;align-items:center;gap:16px}.allmessages-container[_ngcontent-%COMP%]   .messages-header[_ngcontent-%COMP%]   .header-title[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:36px;color:#4f46e5}.allmessages-container[_ngcontent-%COMP%]   .messages-header[_ngcontent-%COMP%]   .header-title[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:32px;font-weight:700;color:#1a1a1a;margin:0}.allmessages-container[_ngcontent-%COMP%]   .messages-header[_ngcontent-%COMP%]   .header-title[_ngcontent-%COMP%]   .conversations-count[_ngcontent-%COMP%]{color:#6b7280;font-size:14px;margin:4px 0 0}.allmessages-container[_ngcontent-%COMP%]   .messages-header[_ngcontent-%COMP%]   .unread-badge[_ngcontent-%COMP%]{background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#fff;padding:10px 20px;border-radius:20px;font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px;box-shadow:0 4px 12px #4f46e54d}.allmessages-container[_ngcontent-%COMP%]   .messages-header[_ngcontent-%COMP%]   .unread-badge[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_bell-ring 2s infinite}.allmessages-container[_ngcontent-%COMP%]   .search-container[_ngcontent-%COMP%]{position:relative;margin-bottom:24px}.allmessages-container[_ngcontent-%COMP%]   .search-container[_ngcontent-%COMP%]   .search-icon[_ngcontent-%COMP%]{position:absolute;right:16px;top:50%;transform:translateY(-50%);color:#9ca3af;font-size:18px}.allmessages-container[_ngcontent-%COMP%]   .search-container[_ngcontent-%COMP%]   .search-input[_ngcontent-%COMP%]{width:100%;padding:14px 50px 14px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:16px;outline:none;transition:all .3s;background-color:#f9fafb}.allmessages-container[_ngcontent-%COMP%]   .search-container[_ngcontent-%COMP%]   .search-input[_ngcontent-%COMP%]:focus{border-color:#4f46e5;background-color:#fff;box-shadow:0 0 0 4px #4f46e51a}.allmessages-container[_ngcontent-%COMP%]   .search-container[_ngcontent-%COMP%]   .search-input[_ngcontent-%COMP%]::placeholder{color:#9ca3af}.allmessages-container[_ngcontent-%COMP%]   .loading-state[_ngcontent-%COMP%]{text-align:center;padding:60px 20px;color:#6b7280}.allmessages-container[_ngcontent-%COMP%]   .loading-state[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:48px;color:#4f46e5;margin-bottom:16px}.allmessages-container[_ngcontent-%COMP%]   .loading-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:16px;margin:0}.allmessages-container[_ngcontent-%COMP%]   .empty-state[_ngcontent-%COMP%]{text-align:center;padding:60px 20px;color:#9ca3af}.allmessages-container[_ngcontent-%COMP%]   .empty-state[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#d1d5db;margin-bottom:16px}.allmessages-container[_ngcontent-%COMP%]   .empty-state[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:20px;font-weight:600;color:#4b5563;margin:0 0 8px}.allmessages-container[_ngcontent-%COMP%]   .empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;margin:0}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]{background-color:#fff;border-radius:16px;box-shadow:0 1px 3px #0000001a;overflow:hidden}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:16px;padding:20px;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:all .2s}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]:hover{background-color:#f9fafb}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]:active{background-color:#f0f9ff}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .avatar-container[_ngcontent-%COMP%]{position:relative;flex-shrink:0}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .avatar-container[_ngcontent-%COMP%]   .user-avatar[_ngcontent-%COMP%]{width:56px;height:56px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px #0000001a}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .avatar-container[_ngcontent-%COMP%]   .online-indicator[_ngcontent-%COMP%]{position:absolute;bottom:2px;right:2px;width:14px;height:14px;border:3px solid #fff;border-radius:50%}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .avatar-container[_ngcontent-%COMP%]   .online-indicator.online[_ngcontent-%COMP%]{background-color:#10b981;box-shadow:0 0 8px #10b98180}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .avatar-container[_ngcontent-%COMP%]   .online-indicator.offline[_ngcontent-%COMP%]{background-color:#6b7280}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]{flex:1;min-width:0}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]   .conversation-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]   .conversation-header[_ngcontent-%COMP%]   .user-name[_ngcontent-%COMP%]{font-size:16px;font-weight:600;color:#1a1a1a;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]   .conversation-header[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{font-size:13px;color:#9ca3af;display:flex;align-items:center;gap:4px;flex-shrink:0}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]   .conversation-header[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:12px}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]   .conversation-footer[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:12px}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]   .conversation-footer[_ngcontent-%COMP%]   .last-message[_ngcontent-%COMP%]{margin:0;font-size:14px;color:#6b7280;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]   .conversation-footer[_ngcontent-%COMP%]   .last-message.unread[_ngcontent-%COMP%]{color:#1a1a1a;font-weight:600}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]   .conversation-footer[_ngcontent-%COMP%]   .unread-count[_ngcontent-%COMP%]{background-color:#4f46e5;color:#fff;font-size:12px;font-weight:700;padding:4px 10px;border-radius:12px;flex-shrink:0;min-width:24px;text-align:center}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]   .conversation-footer[_ngcontent-%COMP%]   .read-indicator[_ngcontent-%COMP%]{color:#10b981;font-size:14px;flex-shrink:0}@keyframes _ngcontent-%COMP%_bell-ring{0%,to{transform:rotate(0)}10%,30%{transform:rotate(-10deg)}20%,40%{transform:rotate(10deg)}50%{transform:rotate(0)}}@media (max-width: 768px){.allmessages-container[_ngcontent-%COMP%]{padding:16px}.allmessages-container[_ngcontent-%COMP%]   .messages-header[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:16px}.allmessages-container[_ngcontent-%COMP%]   .messages-header[_ngcontent-%COMP%]   .header-title[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:28px}.allmessages-container[_ngcontent-%COMP%]   .messages-header[_ngcontent-%COMP%]   .header-title[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:24px}.allmessages-container[_ngcontent-%COMP%]   .messages-header[_ngcontent-%COMP%]   .unread-badge[_ngcontent-%COMP%]{align-self:flex-start}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]{padding:16px}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .avatar-container[_ngcontent-%COMP%]   .user-avatar[_ngcontent-%COMP%]{width:48px;height:48px}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]   .conversation-header[_ngcontent-%COMP%]   .user-name[_ngcontent-%COMP%]{font-size:15px}.allmessages-container[_ngcontent-%COMP%]   .conversations-list[_ngcontent-%COMP%]   .conversation-item[_ngcontent-%COMP%]   .conversation-info[_ngcontent-%COMP%]   .conversation-footer[_ngcontent-%COMP%]   .last-message[_ngcontent-%COMP%]{font-size:13px}}"]})};export{j as AllMessages};
