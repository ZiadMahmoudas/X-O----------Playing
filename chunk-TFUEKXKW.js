import{a as $}from"./chunk-DLUWD6DK.js";import{b as B}from"./chunk-2EPKHZCL.js";import"./chunk-2X2WE554.js";import{a as H}from"./chunk-2DFS2U5V.js";import{a as z,c as Q,h as W,p as q}from"./chunk-2GGCCMO2.js";import{a as L}from"./chunk-G5KA7DMQ.js";import{c as j}from"./chunk-D3ZEN3NJ.js";import{$ as h,Aa as x,Ab as N,Ea as f,Jb as R,Pb as T,Qb as E,Rb as F,Sb as V,Ta as u,Ua as i,Va as a,Wa as m,aa as p,ab as _,cb as v,eb as M,gb as y,hb as S,ib as w,nb as U,ob as O,pa as C,pb as d,qb as b,ra as n,rb as I,sb as P,tb as A,ub as k,va as g,zb as D}from"./chunk-22QBDJS3.js";var J=["messageContainer"];function K(r,e){r&1&&(i(0,"div",15),m(1,"div",16),i(2,"p"),d(3,"\u062C\u0627\u0631\u064A \u062A\u062D\u0645\u064A\u0644 \u0627\u0644\u0631\u0633\u0627\u0626\u0644..."),a()())}function X(r,e){r&1&&(i(0,"div",17),m(1,"i",18),i(2,"p"),d(3,"\u0644\u0627 \u062A\u0648\u062C\u062F \u0631\u0633\u0627\u0626\u0644 \u0628\u0639\u062F"),a(),i(4,"p"),d(5,"\u0627\u0628\u062F\u0623 \u0627\u0644\u0645\u062D\u0627\u062F\u062B\u0629 \u0627\u0644\u0622\u0646!"),a()())}function Y(r,e){if(r&1&&(i(0,"div")(1,"div",21)(2,"p"),d(3),a(),i(4,"span",22),d(5),D(6,"date"),a()()()),r&2){let s=e.$implicit,t=M(2);O(t.isMyMessage(s)?"message my-message":"message other-message"),n(3),b(s.content),n(2),I(" ",N(6,4,s.sentAt,"shortTime")," ")}}function Z(r,e){if(r&1&&(i(0,"div",19),f(1,Y,7,7,"div",20),a()),r&2){let s=M();n(),u("ngForOf",s.messages)("ngForTrackBy",s.trackByMessageId)}}var G=class r{constructor(e,s,t,o,l){this.route=e;this.chatService=s;this.auth=t;this.cdr=o;this.userService=l}messageContainer;currentUserId=0;currentUserName="";otherUserId=0;otherUserName="";otherUserImage="https://res.cloudinary.com/dsqtrbbmw/image/upload/v1760612462/user_ei8llz.jpg";messages=[];newMessage="";isLoading=!1;shouldScroll=!1;otherUserStatus="Offline";messageSubscription;statusSubscription;userSubscription;async ngOnInit(){this.loadCurrentUserFromToken(),this.route.params.subscribe(async e=>{if(this.otherUserId=Number(e.userId),!this.otherUserId&&e.id&&(this.otherUserId=Number(e.id)),!this.otherUserId&&this.route.parent){let s=this.route.parent.snapshot.params;this.otherUserId=Number(s.id||s.userId)}this.currentUserId<=0||this.otherUserId<=0||(await this.loadOtherUserProfile(this.otherUserId),await this.connectSignalR(),this.setupRealtimeListeners(),await this.loadMessages())})}async loadOtherUserProfile(e){try{let s=await this.userService.getCurrentUserById(e).toPromise(),t=s.data||s;t&&(this.otherUserName=t.userName||"\u0645\u0633\u062A\u062E\u062F\u0645 \u063A\u064A\u0631 \u0645\u0639\u0631\u0648\u0641",this.otherUserImage=t.profileImageUrl||this.otherUserImage,this.otherUserStatus=t.status||"Offline")}catch(s){console.error("\u274C Error loading other user profile:",s),this.otherUserName="\u0645\u0633\u062A\u062E\u062F\u0645 \u063A\u064A\u0631 \u0645\u0648\u062C\u0648\u062F"}finally{this.cdr.detectChanges()}}loadCurrentUserFromToken(){let e=this.auth.getAccessToken();if(!e)return;let s=L(e),t=s.sub||s.userId;this.currentUserId=parseInt(t)||0,this.currentUserName=s["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"]||s.name||s.username||"User"}async connectSignalR(){await this.chatService.startConnection(this.currentUserId)}setupRealtimeListeners(){this.messageSubscription=this.chatService.message$.subscribe(e=>{!e||e.senderId===this.currentUserId||e.senderId!==this.otherUserId||this.messages.some(t=>t.content===e.content&&t.senderId===e.senderId&&Math.abs(t.sentAt.getTime()-new Date(e.sentAt||Date.now()).getTime())<5e3)||(this.messages.push({id:e.id||Date.now(),senderId:e.senderId,senderName:e.senderName||"\u0645\u0633\u062A\u062E\u062F\u0645",content:e.content||e.message,sentAt:e.sentAt?new Date(e.sentAt):new Date,isRead:!1}),this.shouldScroll=!0,this.cdr.detectChanges(),this.chatService.markAsRead(this.otherUserId))}),this.statusSubscription=this.chatService.userStatus$.subscribe(e=>{e&&e.userId===this.otherUserId&&this.cdr.detectChanges()})}get isOnline(){return this.otherUserStatus==="Online"}get statusColor(){return this.isOnline?"#28a745":"#6c757d"}async loadMessages(){this.isLoading=!0,this.cdr.detectChanges();try{let e=await this.chatService.getConversation(this.currentUserId,this.otherUserId),s=e?.data||e||[];Array.isArray(s)?(this.messages=s.map(t=>({id:t.id,senderId:t.senderId,senderName:t.senderName||"\u0645\u0633\u062A\u062E\u062F\u0645",content:t.content,sentAt:new Date(t.sentAt),isRead:t.isRead})),this.shouldScroll=!0):this.messages=[]}catch(e){console.error("\u274C Error loading messages:",e),this.messages=[]}finally{this.isLoading=!1,this.cdr.detectChanges()}}sendMessage(){if(!this.newMessage?.trim())return;let e=this.newMessage.trim(),s=Date.now();this.messages.push({id:s,senderId:this.currentUserId,senderName:this.currentUserName,content:e,sentAt:new Date,isRead:!1}),this.newMessage="",this.shouldScroll=!0,this.cdr.detectChanges(),this.chatService.sendMessageViaSignalR(this.otherUserId,e,this.currentUserId),this.chatService.sendMessageViaAPI(this.currentUserId,this.otherUserId,e,this.currentUserName).then(t=>{let o=t?.data?.id||t?.id;if(o){let l=this.messages.findIndex(c=>c.id===s);l!==-1&&(this.messages[l].id=o,this.cdr.detectChanges())}})}ngAfterViewChecked(){this.shouldScroll&&(this.scrollToBottom(),this.shouldScroll=!1)}scrollToBottom(){try{this.messageContainer&&(this.messageContainer.nativeElement.scrollTop=this.messageContainer.nativeElement.scrollHeight)}catch{}}isMyMessage(e){return e.senderId===this.currentUserId}trackByMessageId(e,s){return s.id}ngOnDestroy(){this.messageSubscription?.unsubscribe(),this.statusSubscription?.unsubscribe(),this.chatService.disconnect()}static \u0275fac=function(s){return new(s||r)(g(B),g($),g(j),g(R),g(H))};static \u0275cmp=x({type:r,selectors:[["app-message"]],viewQuery:function(s,t){if(s&1&&y(J,5),s&2){let o;S(o=w())&&(t.messageContainer=o.first)}},decls:19,vars:10,consts:[["messageContainer",""],[1,"chat-container"],[1,"chat-header"],[1,"user-info"],["alt","User",1,"user-avatar",3,"src"],[1,"user-details"],[1,"status"],[1,"messages-container"],["class","loading",4,"ngIf"],["class","no-messages",4,"ngIf"],["class","messages-list",4,"ngIf"],[1,"input-container"],["placeholder","\u0627\u0643\u062A\u0628 \u0631\u0633\u0627\u0644\u062A\u0643...","rows","1",1,"message-input",3,"ngModelChange","keydown.enter","ngModel"],[1,"send-button",3,"click","disabled"],[1,"fas","fa-paper-plane"],[1,"loading"],[1,"spinner"],[1,"no-messages"],[1,"fas","fa-comments","fa-3x"],[1,"messages-list"],[3,"class",4,"ngFor","ngForOf","ngForTrackBy"],[1,"message-content"],[1,"message-time"]],template:function(s,t){if(s&1){let o=_();i(0,"div",1)(1,"div",2)(2,"div",3),m(3,"img",4),i(4,"div",5)(5,"h3"),d(6),a(),i(7,"span",6),d(8),a()()()(),i(9,"div",7,0),f(11,K,4,0,"div",8)(12,X,6,0,"div",9)(13,Z,2,2,"div",10),a(),i(14,"div",11)(15,"textarea",12),k("ngModelChange",function(c){return h(o),A(t.newMessage,c)||(t.newMessage=c),p(c)}),v("keydown.enter",function(c){return h(o),c.preventDefault(),p(t.sendMessage())}),a(),i(16,"button",13),v("click",function(){return h(o),p(t.sendMessage())}),m(17,"i",14),d(18," \u0625\u0631\u0633\u0627\u0644 "),a()()()}s&2&&(n(3),u("src",t.otherUserImage,C),n(3),b(t.otherUserName||"\u0645\u062D\u0627\u062F\u062B\u0629"),n(),U("online",t.isOnline),n(),I(" ",t.isOnline?"\u0645\u062A\u0635\u0644 \u0627\u0644\u0622\u0646":"\u063A\u064A\u0631 \u0645\u062A\u0635\u0644"," "),n(3),u("ngIf",t.isLoading),n(),u("ngIf",!t.isLoading&&t.messages.length===0),n(),u("ngIf",!t.isLoading&&t.messages.length>0),n(2),P("ngModel",t.newMessage),n(),u("disabled",!(t.newMessage!=null&&t.newMessage.trim())))},dependencies:[V,T,E,q,z,Q,W,F],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100vh;max-width:800px;margin:0 auto;background:#f5f5f5}.chat-header[_ngcontent-%COMP%]{background:#075e54;color:#fff;padding:15px;display:flex;align-items:center}.user-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px}.user-avatar[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:50%;object-fit:cover}.status[_ngcontent-%COMP%]{font-size:12px;opacity:.8}.messages-container[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:20px;background:#e5ddd5}.loading[_ngcontent-%COMP%]{text-align:center;padding:50px}.spinner[_ngcontent-%COMP%]{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #075e54;border-radius:50%;animation:_ngcontent-%COMP%_spin 1s linear infinite;margin:0 auto 10px}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.no-messages[_ngcontent-%COMP%]{text-align:center;padding:50px;color:#666}.messages-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:10px}.message[_ngcontent-%COMP%]{display:flex;margin-bottom:10px}.my-message[_ngcontent-%COMP%]{justify-content:flex-end}.other-message[_ngcontent-%COMP%]{justify-content:flex-start}.message-content[_ngcontent-%COMP%]{max-width:60%;padding:10px 15px;border-radius:8px;word-wrap:break-word}.my-message[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{background:#dcf8c6;text-align:right}.other-message[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{background:#fff;text-align:left}.message-time[_ngcontent-%COMP%]{font-size:11px;color:#666;display:block;margin-top:5px}.read-indicator[_ngcontent-%COMP%]{font-size:12px;color:#4fc3f7;margin-left:5px}.input-container[_ngcontent-%COMP%]{display:flex;gap:10px;padding:15px;background:#fff;border-top:1px solid #ddd}textarea[_ngcontent-%COMP%]{flex:1;padding:10px;border:1px solid #ddd;border-radius:20px;resize:none;font-family:inherit;font-size:14px;max-height:100px}.send-button[_ngcontent-%COMP%]{padding:10px 20px;background:#075e54;color:#fff;border:none;border-radius:20px;cursor:pointer;font-weight:700}.send-button[_ngcontent-%COMP%]:disabled{background:#ccc;cursor:not-allowed}.send-button[_ngcontent-%COMP%]:hover:not(:disabled){background:#128c7e}"]})};export{G as Message};
